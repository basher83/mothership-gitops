# ArgoCD HA Upgrade
# Sync-wave 99, manual sync required
# Only trigger after Longhorn is healthy and can provision PVCs
#
# To trigger: argocd app sync argocd-ha
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: argocd-ha-helm
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  project: default
  source:
    repoURL: https://argoproj.github.io/argo-helm
    chart: argo-cd
    targetRevision: 7.*
    helm:
      valuesObject:
        server:
          replicas: 2
          extraArgs:
            - --insecure
          pdb:
            enabled: true
            minAvailable: 1
        controller:
          replicas: 2
        repoServer:
          replicas: 2
          pdb:
            enabled: true
            minAvailable: 1
        redis-ha:
          enabled: true
          persistentVolume:
            enabled: true
            storageClass: longhorn
            size: 1Gi
        configs:
          params:
            server.insecure: true
          cm:
            resource.customizations.ignoreDifferences.apps_Deployment: |
              jsonPointers:
                - /status/terminatingReplicas
            resource.customizations.ignoreDifferences.apps_StatefulSet: |
              jsonPointers:
                - /status/terminatingReplicas
            resource.customizations.ignoreDifferences.apps_ReplicaSet: |
              jsonPointers:
                - /status/terminatingReplicas
            resource.customizations.ignoreDifferences.apps_DaemonSet: |
              jsonPointers:
                - /status/terminatingReplicas
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    # No automated sync - manual trigger required
    syncOptions:
      - ServerSideApply=true
